<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<!-- Chargement d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Échelle de couleurs -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
</head>
<body>
<!-- Ajout de deux boutons -->
<button onclick="MaJ(data1)">Collection 1</button>
<button onclick="MaJ(data2)">Collection 2</button>

<!-- Div où la visu se trouvera. -->
<div id="visu"></div>
<script>

// Dimensions et marges du graphe
var largeur = 450
    hauteur = 450
    marge = 40

// Le rayon du diagramme en secteurs vaut la moitié de la hauteur ou la moitié de la largeur
// (la plus petite de ces deux valeurs). On soustrait un peu de marge.

var radius = Math.min(largeur, hauteur) / 2 - marge

// Ajout d’un svg au div «visu»
var svg = d3.select("#visu")
  .append("svg")
    .attr("width", largeur)
    .attr("height", hauteur)
  .append("g")
    .attr("transform", "translate(" + largeur / 2 + "," + hauteur / 2 + ")");

// création de deux collections pipeau
var data1 = {a: 9, b: 20, c:30, d:8, e:12}
var data2 = {a: 6, b: 16, c:20, d:14, e:19, f:12}

// mise en place de l’échelle de couleurs.
var couleurs = d3.scaleOrdinal()
  .domain(["a", "b", "c", "d", "e", "f"])
  .range(d3.schemeDark2);

// Une fonction qui crée / met à jour le diagramme pour une variable donnée.
function MaJ(data) {

  // Calcul de la position de chaque groupe sur le diagramme
  var clacos = d3.pie()
              .value(function(d) {return d.value; })
              .sort(function(a, b) { /*console.log(a)*/ ; return d3.ascending(a.key, b.key);} ) // Afin que l’ordre reste constant dans le diagramme.
  //console.log(data);
  //console.log(d3.entries(data));
  var data_ready = clacos(d3.entries(data));
  console.log(data_ready);

  // joindre aux données
  var u = svg.selectAll("path")
             .data(data_ready)

  // Construction du diagramme : Chaque part du diagramme en secteurs est un chemin «path» construit grâce à la fonction "arc".
  u.enter()
   .append('path')
   .merge(u)
   .transition()
   .duration(1000)
   .attr('d', (d) => {console.log(d);
                      pathdata = d3.arc().innerRadius(0).outerRadius(radius)(d);
                      console.log(pathdata);
                      return pathdata;}
    )
   .attr('fill', function(d){ return(couleurs(d.data.key)) })
   .attr("stroke", "white")
   .style("stroke-width", "2px")
   .style("opacity", 1);

  // Suppression des éventuels groupes de données qui ne sont plus présents.
  u.exit()
   .remove();

}

// Initialisation du diagramme avec le premier dataset.
MaJ(data1)

</script>
</body>
</html>
